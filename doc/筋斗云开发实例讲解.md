# 筋斗云开发实例讲解

准备好数据模型描述（参考tool\create-wui-page\meta-example.txt）
用在线工具生成对象管理源文件框架： http://localhost/dev/jdcloud/tool/
它可以生成管理端文件、升级数据库、服务端代码、更新菜单项。

也可以直接用命令行工具：server/web/page/create-wui-page.php
先准备好meta.txt文件放在该目录下，然后运行命令：

	create-wui-page.php -

写meta.txt示例：

	@User: id, name(s), storeId, status(4), weixinData(1000), dscr(t), picId, 积分&, adminFlag
	用户: 编号, 昵称, 企业/linkTo:Store/textField:storeName, 状态/enum:UserStatusList, 微信数据, 描述, 头像, 积分, 企业管理员/enum:YesNoMap

- storeId: 链接字段. linkTo/textField.
- status/adminFlag: 枚举字段. enum. 其中常量YesNoMap是框架预定义的，而UserStatusList需要在前端自行定义。
- 积分: 可以直接用中文字段，常用后缀还有：`&` 整数， `@` 货币（高精度小数）

注意：符号最好全用半角英文符号，但也兼容中文逗号和冒号。

## 枚举类型字段

如type，status这种字段，由若干固定值构成。展示的需求为：

- 在对话框中，需要以下拉框的方式选择填写(my-combobox)
- 如果要做映射转化，如status的"CR"值需要显示成"未付款"，则在列表显示以及导出文件时，应显示正确文字。

### 使用Map定义枚举

在pageXXX.html中定义:

	<th data-options="field:'status', jdEnumMap: OrderStatusMap, formatter:Formatter.enum(OrderStatusMap), styler:Formatter.enumStyler({PA:'Warning', RE:'Disabled', CR:'#00ff00'}), sortable:true">状态</th>

在全局文件app.js或应用主文件如store.js中定义全局常量：

	var OrderStatusMap = {
		CR: "未付款", 
		PA: "待服务", 
		RE: "已服务", 
		RA: "已评价", 
		CA: "已取消", 
		ST: "正在服务"
	};

formatter用于设置显示文字；jdEnumMap用于在导出excel时也能正确转换。

上面Formatter.enum及Formatter.enumStyler是框架预定义的常用项，也可自定义formatter或styler，一般在pageXXX.js中定义（如果别的地方需要共用，则放到主逻辑文件如store.js中），如：

	var OrderColumns = {
		status: function (value, row) {
			if (! value)
				return;
			return OrderStatusMap[value] || value;
		},
		statusStyler: function (value, row) {
			var colors = {
				CR: "#000",
				RE: "#0f0",
				CA: "#ccc"
			};
			var color = colors[value];
			if (color)
				return "background-color: " + color;
		}
	};

在pageXXX.html引用：

	<th data-options="field:'status', jdEnumMap: OrderStatusMap, formatter:OrderColumns.status, styler:OrderColumns.statusStyler, sortable:true">状态</th>

在dlgXXX.html中为status字段定义下拉列表：

	<select name="status" class="my-combobox" data-options="jdEnumMap:OrderStatusMap"></select>

参考：my-combobox组件。

### 使用List定义枚举

新的设计中，建议直接使用中文来定义枚举，不必做转换，即status的值直接是"待服务", "已服务"这些，不再用"PA", "RE"这些缩写。
这样上面可简化成：

	<th data-options="field:'status', sortable:true, styler:Formatter.enumStyler({'待服务':'Warning'})">状态</th>

在全局文件app.js或应用主文件如store.js中定义全局常量：

	var OrderStatusList = "未付款;待服务;已服务;已评价;已取消;正在服务";

不再需要设置formatter和jdEnumMap，因为显示和导出文件时无须做文字转换。

styler由于比较简单，可使用Formatter.enumStyler直接为各种状态定义颜色，预设的有Warning, Error, Info, Disabled四种，也可以直接指定颜色，注意null也可指定颜色。

	{'待服务':'Warning', '正在服务':'Error', '已服务':'Info', '未付款':'Disabled', '已取消':'#cccccc', null: 'Error'}

在dlgXXX.html中定义：

	<select name="status" class="my-combobox" data-options="jdEnumList:OrderStatusList"></select>

注意：jdEnumList与jdEnumMap选项格式不同。

### flag字段

示例：是否“企业管理员”字段 - adminFlag

列表页：pageUser.html

	<th data-options="field:'adminFlag', sortable:true, jdEnumMap:YesNoMap, formatter: Formatter.enum(YesNoMap)">企业管理员</th>

详情对话框：dlgUser.html

	<select name="adminFlag" class="my-combobox" data-options="jdEnumMap:YesNoMap"></select>

YesNoMap是框架定义的，显示“是”、“否”，也可以自行定义。

示例：disableFlag - 禁用和启动状态

在app.js中定义常量：

	window.DisableMap = {
		0: "启用",
		1: "禁用"
	};

在列表页：pageXXX.html

	<th data-options="field:'disableFlag', sortable:true, formatter: Formatter.enum(DisableMap), styler:Formatter.enumStyler({1:'Disabled'})">启用状态</th>

详情对话框：dlgXXX.html

	<select name="disableFlag" class="my-combobox" data-options="jdEnumMap:DisableMap"></select>

## 关联字段（外键）

示例：用户关联所在企业(User.storeId=Store.id)

- 在列表页，需要显示企业名(storeName)，而不是storeId，并且链接到用户（点击可打开用户对话框）：pageUser.html
- 在详情页，可用list中选择，而非填写。

实现：

先在设计文档中，为用户查询接口添加返回关联字段storeName: 文件DESIGN.md

	User.query() -> tbl(..., storeName)

在后端添加关联字段：api_objects.php

	class AC0_User extends AccessControl
	{
		protected $vcolDefs = [
			[
				"res" => ["s.name storeName"],
				"join" => "LEFT JOIN Store s ON s.id=t0.storeId",
				"default" => true
			]
		];
	}
	class AC2_User extends AC0_User { }

注意：

- 习惯上，虚拟字段是公用的，所以放在AC0类（超级管理端），再由AC1（用户端）和AC2（管理端）继承。
- 接口设计中storeName后面未加问号, 表示该字段默认就该返回，所以上次设置了`"default"=>true`。

列表页 pageUser.html

	<th data-options="field:'storeId', sortable:true, sorter:intSort, formatter: Formatter.linkTo('storeId', '#dlgStore', 'storeName')">企业</th>

明细页 dlgUser.html
从企业列表中选择：

		<tr>
			<td>企业</td>
			<td>
				<select name="storeId" class="my-combobox" data-options="ListOptions.Store()"></select>
			</td>
		</tr>

在主文件store.js中添加ListOptions.Store定义：

	var ListOptions = {
	...
		Store: function () {
			var opts = {
				valueField: "id",
				textField: "name",
				url: WUI.makeUrl('Store.query', {
					res: 'id,name',
					pagesz: -1
				}),
				formatter: function (row) { return row.id + "-" + row.name; }
			};
			return opts;
		}
	}

## 图片字段 / 视频字段 / 附件字段

需求：

- 可选择、预览、压缩上传图片。
- 支持缩略图（显示缩略图，点击时查看原图）
- 支持单选、复选
- 支持视频和附件文件。

参考wui-upload组件。

在pageXXX.html中为表格设置列：

	<th data-options="field:'picId', sortable:true, sorter:intSort, formatter: Formatter.pics">主图</th>

在dlgXXX.html中设置字段：

单图：

		<tr>
			<td>主图</td>
			<td class="wui-upload" data-options="multiple:false">
				<input name="picId">
			</td>
		</tr>

多图：

		<tr>
			<td>图片</td>
			<td class="wui-upload">
				<input name="pics">
			</td>
		</tr>

## 添加时自动完成某些字段

示例：添加用户时，自动填写:

- 创建时间(User.createTm=当前时间)
- 用户状态(User.status=待审核, 仅当未指定时设置)。
- 所有企业(前端默认取第一个)

在后端完成自动补全：api_object.php

	class AC2_User extends AccessControl
	{
		protected function onValidate()
		{
			if ($this->ac == "add") {
				$_POST["createTm"] = date(FMT_DT);
				if (!issetval("status"))
					$_POST["status"] = "待审核";
			}
		}
	}
 
明细页中，在添加时，要求“创建时间”字段不可填，而状态字段自动变成“待审核”：在dlgUser.js中动态修改

	function onBeforeShow(ev, formMode, opt) 
	{
		var objParam = opt.objParam;
		var forAdd = formMode == FormMode.forAdd;
		setTimeout(onShow);

		function onShow() {
			// 添加时灰掉createTm字段
			frm.createTm.disabled = forAdd;
			// 添加时自动填写字段
			if (forAdd) {
				$(frm.status).val("待审核");
				$(frm.storeId).val(1);
			}
		}
	}

设置值时，尽量用jQuery操作。虽然一般也可以用

	frm.status.value = "待审核";
	frm.storeId.value = 1;

但是会有bug，比如当第一次打开对话框做添加操作时，企业列表尚未加载成功，设置`frm.storeId.value=1`无效。
而select控件的jQuery.val函数做了扩展，用`$(frm.storeId).val(1)`就可以成功操作。

## 密码字段 / 格式化显示

需求：pwd字段，要求在对话框显示成`****`。

在dlgUser.html中，

	function onBeforeShow(ev, formMode, opt) 
	{
		if (formMode == FormMode.forSet)
			opt.data.pwd = "****";
	}

注意：和前面章节在添加时给初值不同，当时是在onShow中设置UI组件；而这里是在onBeforeShow中修改初始数据opt.data。
因为，如果设置UI组件，则提交时判断UI与初值不同，就会提交修改；而修改了初值，在提交时，如果在UI上未修改，就不会做提交。

## 后端查询时加限制条件

示例：条目Item分为多个类别type. 查询条目接口:

	Item.query(type?)

	- 当type="广告位"时，按cond="广告位优先级>0"查询，默认按此优先级倒序排列；
	- 当type="新鲜事"时，过滤type="活动"/"集市"的条目。
	- 否则按type指定值过滤。

实现：api_objects.php, 在onQuery中用addCond增加条件：

	protected function onQuery()
	{
		$type = param("type");
		if ($type) {
			if ($type == "广告位") {
				$this->addCond("广告位优先级>0");
				// 设置排序条件，可以设置`$this->defaultSort`(可被orderby接口参数覆盖)，也可写死即设置`$this->sqlConf["orderby"]`
				//$this->sqlConf["orderby"] = "广告位优先级 DESC";
				$this->defaultSort = "广告位优先级 DESC";
			}
			else if ($type == "新鲜事") {
				$this->addCond("type IN ('活动', '集市')");
			}
			else {
				$this->addCond("type=" . Q($type));
			}
		}
	}

添加过滤逻辑示例：

	Item.query(q?)

	- AUTH_USER
	- 默认用户只能看已发布的所有条目(即按status='发布中'过滤)
	- 用户可以看到自己的除了“已删除”状态外的所有条目，指定参数为`q=my`

在api_objects.php的AC1_User中实现：

	protected function onQuery()
	{
		...
		$q = param("q");
		if ($q == "my") {
			$uid = $_SESSION["uid"];
			$this->addCond("userId=$uid");

			$this->addCond("status<>'已删除'");
		}
		else {
			$this->addCond("status='发布中'");
		}
	}

## 更新操作与特定权限

**[需求]**

- 只有“企业管理员”权限的用户才能更新企业信息。且只能更新自己企业的信息。
- 名称、企业积分字段不可更新。

**[数据模型]**

	@User: id, storeId, adminFlag
	- adminFlag: 是否是企业管理员
	@Store: id, name, 积分, 地址, 联系人

**[接口设计]**

	Store.set()(地址, 联系人, ...)

	- (AUTH_USER & PERM_ADMIN_USER) | AUTH_EMP
	- 只可更新自己所在企业，不必传id

**[后端实现]**

先定义一个权限PERM_ADMIN_USER，表示企业管理员. api.php

	// 权限类型
	...
	const PERM_ADMIN_USER = 0x200;

	$PERMS = [
		...
		PERM_ADMIN_USER => "admin-user",
	];

在用户登录时保存adminFlag字段到session：php/class/LoginImp.php
LoginImp.onLogin是login插件的接口实现，参考login插件。(plugin/login)

	class LoginImp extends LoginImpBase
	{
		// 登录成功时回调
		function onLogin($type, $id, &$ret)
		{
			if ($type == "user") {
				$_SESSION["adminFlag"] = $ret["adminFlag"];
			}
		}
	}

在onGetPerms中设置权限：api.php

	function onGetPerms()
	{
		$perms = 0;
		if (isset($_SESSION["uid"])) {
			$perms |= AUTH_USER;
			if ($_SESSION["adminFlag"]) {
				$perms |= PERM_ADMIN_USER;
			}
		}
		...
	}

注意：用户权限一旦被修改，必须重新登录才能生效。

session变量属于重要的后端内部接口，在主设计文档DESIGN.md中添加说明：

	## 后端内部接口

	会话变量：

	- 用户登录
		- uid: 用户编号
		- adminFlag: 管理员标志
	- 员工登录
		- empId: 员工编号

实现Store.set接口: api_objects.php
检查PERM_ADMIN_USER权限，并自动补上id参数，

	class AC1_Store extends AC_Store
	{
		// 默认没有set操作
		protected $allowedAc = ["get", "query"];
		protected $readonlyFields = ["企业积分", "name"];

		protected function onInit() {
			// 当有权限时才加set操作
			if (hasPerm(PERM_ADMIN_USER)) {
				$this->allowedAc[] = "set";
			}
		}
		protected function onValidateId() {
			// set时强制设置成自己企业。
			if (!param("id") || $this->ac == "set") {
				$uid = $_SESSION["uid"];
				$this->id = queryOne("SELECT storeId FROM User WHERE id=" . $uid);
			}
		}
	}

用`$allowedAc`来限制操作；
用`$readonlyFields`来限制更新操作的字段。add/set操作都不可设置这些字段。
如果add接口可以设置该字段，但set操作不可以改，应使用`$readonlyFields2`。假如此例中"name"想要在添加时可指定，但企业积分add/set时都只读：

		protected $readonlyFields = ["企业积分"];
		protected $readonlyFields2 = ["name"];

AC1类保证了用户已登录（可以安全地取session变量uid），
用`hasPerm()`来判断权限，如“企业管理员”时添加"set"接口。也可用`checkAuth`检查权限，不符时将直接报错返回。

**[限制set操作]**

上面为了限制set操作只对本企业，直接在onValidateId中设置id。这意味着即使是给定了错误的id，也不会报错，而是仍修改本企业。
标准的做法是在onQuery中为set操作限定范围，如下：

	class AC1_Store extends AC_Store
	{
		...
		protected function onValidateId() {
			if (! param("id")) { // 不强制设置set操作的id
				$uid = $_SESSION["uid"];
				$this->id = queryOne("SELECT storeId FROM User WHERE id=" . $uid);
			}
		}
		protected function onQuery() {
			// 对set的范围进行限定
			if ($this->ac == "set") {
				$uid = $_SESSION["uid"];
				$storeId = queryOne("SELECT storeId FROM User WHERE id=" . $uid);
				$this->addCond("id=$storeId");
			}
		}
	}

这时，如果给定的id不正确，就会直接报错。

## 查询时的字段隐藏

示例：查询用户时，隐藏微信数据等字段。

	@User: id, name, weixinKey, weixinData(2000)

后端实现：api_objects.php
设置`$hiddenFields`.

	class AC1_User extends AC0_User
	{
		protected $hiddenFields = ["weixinData", "weixinKey"];
	}

## 查询或更改时限制操作内容

在onQuery中限制操作范围。

需求：

- 用户只能查看自己所在企业的员工
- 用户只能修改自己；如果是企业管理员(PERM_ADMIN_USER)，可修改本企业的员工

数据模型：

	@Store: id, name
	@User: id, name, storeId

交互接口：

	User.query()
	User.get(id?)
	User.set(id?)

	限定查看自己企业的用户，限定只能操作自己的数据。
	但企业管理员可修改企业中的用户。
	如果未指定id参数，以当前用户id补齐。

后端实现：

	class AC1_User extends AC0_User
	{
		protected $allowedAc = ["get", "set", "query"];

		protected function onValidateId()
		{
			// 自动补上id参数
			if (!param("id")) {
				$uid = $_SESSION["uid"];
				$this->id = $uid;
			}
		}
		protected function onQuery() {
			$uid = $_SESSION["uid"];
			// 读操作(get/query)或是管理员，限制storeId
			if ($this->ac == "get" || $this->ac == "query" || hasPerm(PERM_ADMIN_USER)) {
				$storeId = queryOne("SELECT storeId FROM User WHERE id=" . $uid);
				$this->addCond("storeId=$storeId");
			}
			// 写操作，限制uid
			else {
				$this->addCond("id=$uid");
			}
		}
	}

## 查询时动态添加字段

使用addRes动态添加字段。

需求：预订会议室时，根据日期查看会议室列表。

数据模型：

	@Room: id, name
	@RoomOrder: id, roomId, 时段

接口：

	Room.query(dt?) -> tbl(id, ..., 已用时段?)

	- dt: 如果指定日期dt，则返回每个会议室当天已被占用的时段

后端实现：

	class AC1_Room extends AccessControl
	{
		protected $allowedAc = ["get", "query"];
		protected function onQuery() {
			$dt = param("dt/dt");
			if ($dt) {
				$dtStr = date(FMT_DT, $dt);
				$this->addRes("(SELECT group_concat(时段) FROM RoomOrder WHERE roomId=t0.id AND dt='$dtStr' AND status<>'已取消') 已用时段");
			}
		}
	}

